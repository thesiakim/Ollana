# C104 í¬íŒ…ë©”ë‰´ì–¼

## âš™ï¸ ì‚¬ìš© ê¸°ìˆ  ìŠ¤íƒ

| êµ¬ì„± ìš”ì†Œ         | ê¸°ìˆ                              |
|------------------|----------------------------------|
| CI ë„êµ¬          | Jenkins (Docker ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì‹¤í–‰) |
| ì½”ë“œ ì €ì¥ì†Œ       | GitLab                           |
| ë°±ì—”ë“œ ì„œë¹„ìŠ¤     | Spring Boot                      |
| AI ì˜ˆì¸¡ ì„œë¹„ìŠ¤    | FastAPI (Python)                 |
| DB               | PostgreSQL + PostGIS             |
| ìºì‹œ ì„œë²„         | Redis                             |
| ì •ì  ë¶„ì„ ë„êµ¬    | SonarQube                         |
| ì»¨í…Œì´ë„ˆ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ | Docker Compose           |
| ì¸ì¦ ì •ë³´ ê´€ë¦¬    | Jenkins Credentials + `.env` íŒŒì¼ |

## ì£¼ìš” ì•„í‚¤í…ì³ ìš”ì•½
- `docker-compose.yml` : Jenkins, DB, Redis, SonarQube ë“± 1ì°¨ ì¸í”„ë¼ ì¤€ë¹„íŒŒì¼
- `docker-compose-deploy.yml` : Spring Boot, FastAPI ë“± ì„œë²„ ì‹¤ì§ˆ ì½”ë“œ ë°°í¬ ì˜ì—­ ë‹´ë‹¹
- JenkinsëŠ” GitLabì—ì„œ webhookìœ¼ë¡œ íŠ¸ë¦¬ê±°ë˜ë©°, `.env` íŒŒì¼ì„ ìë™ ìƒì„±í•˜ì—¬ ì„œë¹„ìŠ¤ í™˜ê²½ì„ êµ¬ì„±í•˜ê³ , `rsync`ë¥¼ í†µí•´ Git ê¸°ì¤€ ì†ŒìŠ¤ë¥¼ ì„œë²„ì— ë³µì‚¬í•œ ë’¤ `docker compose up`ìœ¼ë¡œ ë°°í¬ ìˆ˜í–‰
- ê° ai, backendëŠ” ê°ê°ì˜ dockeríŒŒì¼ë¡œ ì»¨í…Œì´ë„ˆí™”

## â—ì£¼ì˜ì‚¬í•­
- ì»¨í…Œì´ë„ˆ ì •ì§€ì‹œì—ëŠ” stop-all.shë¡œ ìë™í™”
  ```
    #!/bin/bash
    set -e

    echo "(backend, ai) compose down"
    docker compose -f docker-compose-deploy.yml down

    echo "CI compose down"
    docker compose down

    echo "all compose down complete!"
  ```
- Dockerë¥¼ ë¶™íˆëŠ” ë„¤íŠ¸ì›Œí¬ëŠ” ì‚¬ì „ì— ìƒì„± í•„ìš”
  ```
  networks:
  jenkins_shared_net:
    external: true
  ```
- Jenkins í™ˆ ë””ë ‰í† ë¦¬ëŠ” ë³„ë„ ë°±ì—… ì‘ì—… ë° ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”
- .envíŒŒì¼ì€ ìë™ ìƒì„± ë° ì‚­ì œë˜ë¯€ë¡œ ìˆ˜ë™ ê´€ë¦¬ ê¸ˆì§€

## í¬íŠ¸ ì„¤ëª…
| í¬íŠ¸ ë²ˆí˜¸ | ìš©ë„                     |
|-----------|--------------------------|
| 8080      | Jenkins (ë‚´ë¶€ìš© 9090 í¬ì›Œë”©) |
| 5432      | PostgreSQL               |
| 6379      | Redis                    |
| 9000      | SonarQube Web UI         |
| 9080      | Spring Boot (ë°±ì—”ë“œ)     |
| 9081      | FastAPI (AI ì„œë²„)        |

## ë””ë ‰í† ë¦¬ êµ¬ì¡°
```
/home/ubuntu/jenkins-docker/
â”œâ”€â”€ back/
â”‚   â””â”€â”€ ollana/         # Spring Boot í”„ë¡œì íŠ¸
â”œâ”€â”€ ai/                 # FastAPI í”„ë¡œì íŠ¸
â”œâ”€â”€ jenkins_home/       # Jenkins ë³¼ë¥¨ ë°ì´í„°
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ docker-compose-deploy.yml
â”œâ”€â”€ sonar.properties
â””â”€â”€ stop-all.sh
```

## Dockerfile êµ¬ì¡°ì„¤ëª…
### `python`
```Dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .
EXPOSE 8000

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```   
  - ìŠ¬ë¦¼í•œ íŒŒì´ì¬ ì´ë¯¸ì§€ ì‚¬ìš©
  - requirements ë³µì‚¬í•˜ì—¬ uvicorn ì„œë²„ ì‹¤í–‰, main.appì„ ì§„ì…ì ìœ¼ë¡œ ì‚¬ìš©  

### `Spring Boot`
```Dockerfile
FROM openjdk:17-jdk-slim

WORKDIR /app

COPY build/libs/*.jar app.jar
EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```
  - java 17 ê¸°ì¤€ ìŠ¬ë¦¼í•œ ì´ë¯¸ì§€ ì‚¬ìš©

## âš™ï¸ Jenkins ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ êµ¬ì¡° ì„¤ëª…
### ì „ì²´ ë™ì‘ íë¦„ ìš”ì•½

1. Jenkins Credentialsë¡œë¶€í„° í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
2. `.env` íŒŒì¼ ìƒì„± (Docker Composeìš©)
3. Git ê¸°ì¤€ìœ¼ë¡œ ì†ŒìŠ¤ì½”ë“œ `rsync` ë³µì‚¬
4. Spring Boot í”„ë¡œì íŠ¸ Gradle ë¹Œë“œ
5. SonarQube ì •ì  ë¶„ì„ ì‹¤í–‰
6. í˜„ì¬ ë¸Œëœì¹˜ê°€ `dev`ì¼ ê²½ìš°ë§Œ ì‹¤ì œ ë°°í¬ ì‹¤í–‰
7. ì„ì‹œ íŒŒì¼ ì •ë¦¬

#### git ê¸°ì¤€ ë™ê¸°í™”ëŠ” `rsync` ì‚¬ìš©
  ```bash
  git ls-files > .rsync-include.txt
  rsync -av --delete \
  --files-from=".rsync-include.txt" \
  "$WORKSPACE/back/ollana/" \
  /home/ubuntu/jenkins-docker/back/ollana/
  ```
- Gitì´ ì¶”ì í•˜ëŠ” íŒŒì¼ë§Œ ëŒ€ìƒìœ¼ë¡œ ë³µì‚¬
- Gitì—ì„œ ì‚­ì œëœ íŒŒì¼ì€ í•¨ê»˜ ì‚­ì œ
- Gitì´ ì¶”ì í•˜ì§€ ì•ŠëŠ” ì„¤ì • íŒŒì¼(ì˜ˆ: ë¡œì»¬ ë¡œê·¸)ì€ ë³´ì¡´

#### Spring Boot ë¹Œë“œ ë° SonarQube ë¶„ì„
```bash
./gradlew build -x test --build-cache

./gradlew sonarqube \
  -Dsonar.projectKey=S12P31C104 \
  -Dsonar.host.url=https://k12c104.p.ssafy.io/sona \
  -Dsonar.login="${SONAR_TOKEN}"
```
- í…ŒìŠ¤íŠ¸ë¥¼ ì œì™¸í•œ ì •ì ë¶„ì„
- ê²°ê³¼ëŠ” ì›¹ UIì—ì„œ í™•ì¸

#### ë¸Œëœì¹˜ ì¡°ê±´ì— ë”°ë¥¸ ë°°í¬ ì²˜ë¦¬
```bash
if [[ "$GIT_BRANCH" == "origin/dev" ]]; then
  docker compose --env-file ... up -d --build
fi
```
- devë¸Œë Œì¹˜ì¼ë•Œë§Œ ì‹¤ì œ ë°°í¬
- ë‹¤ë¥¸ ë¸Œë Œì¹˜ì¼ë•ŒëŠ” Test build ë¡œ íŒŒì´í”„ë¼ì¸ êµ¬ì„±
- Test build ì‹¤íŒ¨ì‹œ merge block
- ëìœ¼ë¡œ ë°°í¬ ë§ˆë¬´ë¦¬ì‹œ ì„ì‹œ íŒŒì¼ ì‚­ì œ ì‘ì—…

## ğŸ” ì „ì²´ ë°°í¬ íë¦„ ìš”ì•½

```text
[ê°œë°œì GitLab Push]
          â†“
     [GitLab Webhook]
          â†“
       [Jenkins]
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ 1. í™˜ê²½ë³€ìˆ˜ ë¡œë“œ       â”‚
 â”‚ 2. .env íŒŒì¼ ìƒì„±      â”‚
 â”‚ 3. ì†ŒìŠ¤ rsync ë³µì‚¬     â”‚
 â”‚ 4. Gradle ë¹Œë“œ         â”‚
 â”‚ 5. SonarQube ë¶„ì„       â”‚
 â”‚ 6. Docker Compose ë°°í¬ â”‚ â† dev ë¸Œëœì¹˜ì¼ ê²½ìš°
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
  [Spring Boot & FastAPI ì„œë¹„ìŠ¤ ê¸°ë™]
```

## ìì£¼ ë°œìƒí•˜ëŠ” í¬íŒ… ì´ìŠˆ
- `ì»¨í…Œì´ë„ˆ ì¶©ëŒ ë¬¸ì œ` : Jenkinsì™€ ê° ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí¬ ì„¤ì • í™•ì¸
- `Git ì†ŒìŠ¤ê°€ ë‹¤ë¦„` : rsyncê¸°ì¤€ê³¼ ë¹Œë“œ ê¸°ì¤€ í™•ì¸
- `SonarQube ì ‘ì† ë¶ˆê°€` : resource ë¡œë”© ë„¤íŠ¸ì›Œí¬ ë¡œê·¸ í™•ì¸
- `Permission denied`: sudo ëª…ë ¹ì–´ì™€ chmod +x ëª…ë ¹ì–´ í™•ì¸

## ë°±ì—”ë“œ .env ë³€ìˆ˜ ì„¤ëª…

| ë³€ìˆ˜ëª… | ì„¤ëª… |
|--------|------|
| `DB_USERNAME`, `DB_PASSWORD` | PostgreSQL ì ‘ì† ê³„ì • ì •ë³´ |
| `JWT_SECRET` | JWT ì•”í˜¸í™” ì‹œ ì‚¬ìš©ë˜ëŠ” ì‹œí¬ë¦¿ í‚¤ |
| `JWT_ACCESS_EXPIRATION` | Access Token ë§Œë£Œ ì‹œê°„ (ì´ˆ ë‹¨ìœ„) |
| `JWT_REFRESH_EXPIRATION` | Refresh Token ë§Œë£Œ ì‹œê°„ (ì´ˆ ë‹¨ìœ„) |
| `JWT_PASSWORD_RESET_EXPIRATION` | ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í† í° ë§Œë£Œ ì‹œê°„ |
| `REDIS_HOST`, `REDIS_PORT`, `REDIS_PASSWORD` | Redis ì ‘ì† ì •ë³´. Docker ë„¤íŠ¸ì›Œí¬ ë‚´ ì»¨í…Œì´ë„ˆ ì´ë¦„ ì‚¬ìš© |
| `AWS_IAM_ACCESS_KEY`, `AWS_IAM_SECRET_KEY` | AWS S3 ì—°ë™ì„ ìœ„í•œ IAM í‚¤ ì •ë³´ |
| `AWS_S3_BUCKET_NAME` | ì—…ë¡œë“œ ëŒ€ìƒ AWS S3 ë²„í‚· ì´ë¦„ |
| `DEFAULT_IMAGE_URL` | ê¸°ë³¸ í”„ë¡œí•„ ë˜ëŠ” ì¸ë„¤ì¼ ì´ë¯¸ì§€ URL |
| `API_SERVICE_KEY` | ì™¸ë¶€ ê³µê³µ/ì„œë“œíŒŒí‹° API ì—°ë™ í‚¤ |
| `SMTP_USERNAME`, `SMTP_PASSWORD` | SMTP ì´ë©”ì¼ ì „ì†¡ìš© ê³„ì • ì •ë³´ |
| `KAKAO_CLIENT_ID`, `KAKAO_REDIRECT_URI` | ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í´ë¼ì´ì–¸íŠ¸ ì„¤ì • |
| `OPEN_WEATHER_API_KEY` | OpenWeatherMap API í‚¤ |
| `KAKAO_ADMIN_KEY` | ì¹´ì¹´ì˜¤ Open API ì„œë²„ ì¸ì¦ìš© Admin Key |

---

## í”„ë¡ íŠ¸ì—”ë“œ .env ë³€ìˆ˜ ì„¤ëª…
#### í”„ë¡ íŠ¸ì—”ë“œëŠ” ì–´í”Œì´ë¼ ë°°í¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
| ë³€ìˆ˜ëª… | ì„¤ëª… |
|--------|------|
| `NAVER_MAP_KEY` | ë„¤ì´ë²„ ì§€ë„ ì„œë¹„ìŠ¤ìš© API í‚¤ |
| `NAVER_MAP_CLIENT_ID` | ë„¤ì´ë²„ ì§€ë„ í´ë¼ì´ì–¸íŠ¸ ID |
| `BASE_URL` | ë°±ì—”ë“œ API ê¸°ë³¸ ë„ë©”ì¸ (Spring Boot) |
| `AI_BASE_URL` | AI ì„œë²„ API ê¸°ë³¸ ë„ë©”ì¸ (FastAPI) |
| `KAKAO_CLIENT_ID` | ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ìš© í”„ë¡ íŠ¸ í´ë¼ì´ì–¸íŠ¸ ID |
| `KAKAO_REDIRECT_URI` | ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë¦¬ë‹¤ì´ë ‰íŠ¸ URL (í”„ë¡ íŠ¸ì—”ë“œ ê¸°ì¤€) |

## Nginx ì„¤ì • ì˜ˆì‹œ
```nginx
server {
    listen 80;
    listen [::]:80;
    server_name k12c104.p.ssafy.io;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name k12c104.p.ssafy.io;

    ssl_certificate /etc/letsencrypt/live/k12c104.p.ssafy.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/k12c104.p.ssafy.io/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "frame-ancestors 'self'" always;

    limit_req zone=req_limit_per_ip burst=50 nodelay;
    limit_conn conn_limit_per_ip 10;

    location /jenkins/ {
         proxy_pass http://localhost:9090/jenkins/;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         proxy_set_header X-Forwarded-Proto $scheme;
         proxy_set_header X-Forwarded-Port 443;
         proxy_set_header X-Forwarded-Host $host;
         proxy_set_header X-Forwarded-Prefix /jenkins;
         proxy_redirect http:// https://;
   }

   location /back-api/ {
         proxy_pass http://localhost:9080/;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
   }

   location /ai/ {
         proxy_pass http://localhost:9081/;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
   }

   location / {
         proxy_pass http://localhost:9000/;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         proxy_set_header X-Forwarded-Proto $scheme;
         proxy_set_header Accept-Encoding "";

         proxy_redirect off;
         gzip off;
   }
}
```
- SSLì¸ì¦ ì‚¬ìš©ìœ¼ë¡œ HTTPS í†µì‹ 
- ê°ì¢… í—¤ë” ë³´ì•ˆìœ¼ë¡œ ì¶”ê°€
- IP ì œí•œ ë° ìš”ì²­ì†ë„ ì œí•œìœ¼ë¡œ DDOSë°©ì–´